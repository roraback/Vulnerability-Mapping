var drawerOpen=false;
var subGeoShowing = false;
var subGeoHover = true;
var reassignRatings;
var activeWindow;
var markersOn=false;
var median;
var highest_level = 3;
var updateChart;
var setLevel;
var ratingsObject; // JSON object with fake ratings
var reportsHeight = window.innerHeight-111;
var submitDataHeight = window.innerHeight-186;
var activeContentHeight = 0;
var resizeReports, resizeSubmitData;
var timelineMin = 1989;
var timelineMax = 2012;
var activeYear;
var demographicsLoader;
var numberSubmissions = 2;
var numberSubmissionsDeleted = 0;
var numberSubmissionsHidden = 0;
var showDemographicsInput;
var removeDataSubmitted;
var deleteDuringReview;

$(document).ready(function(){
        
    TypeHelpers.insertClasses();
    
    $("#dataTopBar").hover(function(){
        $("#dataTopBar img").css("background-color", "#f7941d");
        $("#dataTopBar img").attr("src", "img/assets/dropdownArrowOverPng8.png");
        $("#dataOptions").fadeIn(150);
        $("#defaultDataLink").css("color", "#c47a21");
    },
    function(){
        $("#dataTopBar img").css("background-color", "transparent");
        $("#dataTopBar img").attr("src", "img/assets/dropdownArrowPng8.png");
        $("#dataOptions").fadeOut(150);
        $("#defaultDataLink").css("color", "#f7941d");
    });
    $("#reportsTopBar").hover(function(){
        $("#reportsTopBar img").css("background-color", "#f7941d");
        $("#reportsTopBar img").attr("src", "img/assets/dropdownArrowOverPng8.png");
        $("#reportsOptions").fadeIn(150);
        $("#defaultReportsLink").css("color", "#c47a21");
    },
    function(){
        $("#reportsTopBar img").css("background-color", "transparent");
        $("#reportsTopBar img").attr("src", "img/assets/dropdownArrowPng8.png");
        $("#reportsOptions").fadeOut(150);
        $("#defaultReportsLink").css("color", "#f7941d");
    });
    $(".closechromeframe").click(function(){ $(".chromeframe").hide(); });
    
    $('#timelineSlider').slider({
		value: 2010,
		min: 1990,
		max: 2012,
		step: 1,
		slide: function( event, ui ) {
			$( "#amount" ).val( ui.value );
		}
	});
	$( "#amount" ).val( 2012 );

	// set up selectmenu for chart
	$("#chartSwitcher").selectmenu({
	    style: "popup",
	    maxHeight:280,
	    width:125,
	    menuWidth:125
	});
		
	$("#reportFilters select, #submitDataFilters select, .subGeoSelect, #browseOtherRegions select").selectmenu({
	    style: "popup",
		maxHeight:280,
		width:160,
		menuWidth:160,
		icons: [
			{find: '.one'},
			{find: '.two'},
			{find: '.three'},
			{find: '.four'},
			{find: '.five'}
		]	    
	});
	
	$("#analysis select, #analysisToggle select").selectmenu({
	    style: "popup",
	    maxHeight:280,
	    width:160,
	    menuWidth:160
	});
	
    // $("#amount").change( function(){ console.log($("#amount").val()) });

    //click events for opening/closing drawer
    $("#show-hide").click(function(){ drawerSlide(); });
    $("#risingTab").click(function(){ drawerSlide(); });

    $("#subGeo, .currentQuality").hover(
        function(){ //show popup with sub-geography if user hovers for .2 second
            var tempPopupDivVar = $(this).find(".popup");
            $(tempPopupDivVar).data('timeout', setTimeout(function(){ showSubGeo(tempPopupDivVar, 200); }, 200)) },
        function(){ 
            var tempPopupDivVar = $(this).find(".popup");
            hideSubGeo(tempPopupDivVar, 200);
            clearTimeout($(tempPopupDivVar).data('timeout'));
        }); // cancel popup if user moves mouse before .2 second passes

    $(".listText").hover(
        function(){
            showSubGeo($(this).siblings(".popup"), 0);
        },
        function(){
            hideSubGeo($(this).siblings(".popup"), 0);
    });
        
    $("#subGeoPopup").hover(
        function(){ 
            if(!subGeoHover){  // on mouseover, if the mouseout counter is still going, cancel it
                clearTimeout($(this).data('timeout'));
                subGeoHover=true;
            }
        },
        function () { //if the user moves mouse away from the div, start a .3s timer before hiding the sub-geography popup
            var tempPopupDivVar = $(this);
            subGeoHover = false;
            $(this).data('timeout', setTimeout( function () {
                hideSubGeo(tempPopupDivVar);
            }, 300));
    });

    // $("#closeSubGeo").click(function(){ showSubGeo(); });

    // grab search value when search is clicked AND when enter/return is pressed (while the search is in focus)
    $("#searchSubmit").click(function(){ alert( $("#search input").val()); });  
    $("#search input").keyup(function(keyEvent){
        if(keyEvent.which==13){
            alert( $("#search input").val() );
        }
    });


    // open the reports section/lightbox background when reports links are clicked
    $(".reports").click(function(){ 
        showReports("pending");
    });
    
    $(".infoWindow img").click(function(){
        $("#lightbox, #photoPanel").fadeIn(300);
    });
    
    $(".calculationLink").click(function(){
        $("#lightbox, #calculationView").fadeIn(300);
    });
    
    //close sections when lightbox surrounding area OR x in UR corner is clicked
    $("#lightbox").click(function(){ 
        if($("#submitDataContent").is(":visible")){
            $("#submitDataContent").animate({"scrollTop":0},100);
        }
        $("#lightbox, #reportsSection, #calculationView, #photoPanel, #submitDataSection").fadeOut(300);
    });
    $("#reportsSection .closePanel").click(function(){
        $("#lightbox, #reportsSection").fadeOut(300);
    });
    $("#submitDataSection .closePanel").click(function(){
        $("#submitDataContent").animate({"scrollTop":0},100);
        $("#lightbox, #submitDataSection").fadeOut(300);
    });
    $("#calculationView .closePanel").click(function(){
        $("#lightbox, #calculationView").fadeOut(300);
    });
    $("#photoPanel .closePanel").click(function(){
        $("#lightbox, #photoPanel").fadeOut(300);
    });
    $(".subGeoReportsButton").click(function(){
        showReports('pending');
    });
    $(".subGeoAnalysisButton").click(function(){
        showAnalysis();
    });
    $(".subGeoSubmitDataButton").click(function(){
        showSubmitData("indicators");
    });
    
    $(".reviewButton").click(function(){
        $(".rowForApproval").hide();
        $(".rowForApproval").prev().find(".closeReviewButton").hide();
        $(".rowForApproval").prev().find(".reviewButton").fadeIn(200);
        $(this).parent().parent().next(".hiddenRow").addClass("rowForApproval").show("slow");
        $(this).hide();
        $(this).siblings(".closeReviewButton").fadeIn(200);
        resizeReports();
    });
    $(".closeReviewButton").click(function(){
        $(this).parent().parent().next(".hiddenRow").hide();
        $(this).hide();
        $(this).siblings(".reviewButton").fadeIn(200);
        resizeReports();
    });
    
    $(".approveButton, .declineButton").click(function(){
        $(this).parent().parent().parent().hide();
        $(this).parent().parent().parent().prev().hide();
        if($(this).hasClass("approveButton")){
            $(".approvalScreen .thanks").html("Thank you for your approval.");
        }else{
            $(".approvalScreen .thanks").html("Thank you, the submission<br />has been declined.")
        }
        $(".approvalScreen").fadeIn(300);
        $(".approvalScreen").data('approvalTimeout', setTimeout(function(){ $(".approvalScreen").fadeOut(300); }, 5000));
        resizeReports();
    });
    
    $(".headerRow").click(function(){
        $(".rowForApproval").hide();
        $(".rowForApproval").prev().find(".closeReviewButton").hide();
        $(".rowForApproval").prev().find(".reviewButton").show();
        $(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");
        $(".headerRow.activeSection").removeClass("activeSection");
        $(this).addClass("activeSection");
        $(".headerRow.activeSection .arrow").html("&darr;");
        $(".activeContent").hide("slow");
        $(".activeContent").removeClass("activeContent");
        $(this).next().addClass("activeContent");
        $(this).parent().next().addClass("activeContent");
        $(".activeContent").fadeIn(200);
        resizeReports();
    });
    
    $(".return2reports").click(function(){
        $(".approvalScreen").fadeOut(300);
        clearTimeout($(".approvalScreen").data('approvalTimeout'));
    });
    
    //fake country selection when user is in global view.
    $("#vulnerability").click(function(){
        if(!$("#l0_breadcrumb").is(":visible")){
            $("#show-hide, #divider, #analysisLink, #risingTab").fadeIn(200);
            $("#l0_select option[value='vietnam']").attr("selected",true);
            $("#l0_select").selectmenu("destroy").selectmenu({
        	    style: "popup",
        		maxHeight:280,
        		width:160,
        		menuWidth:160,
        		icons: [
        			{find: '.one'},
        			{find: '.two'},
        			{find: '.three'},
        			{find: '.four'},
        			{find: '.five'}
        		]
        	});
            reassignRatings(0);
            $(".activeWindow").fadeIn(300);
        }
    });
    $(window).resize(function(){ 
        if($("#reportsSection").is(":visible")){
            resizeReports();
        }else if($("#submitDataSection").is(":visible")){
            resizeSubmitData();
        }
    });
    
    resizeReports = function(){
        reportsHeight = $(window).innerHeight()-111;
        activeContentHeight = 0;
        $(".activeContent.contentTable .content").children("tr:visible").each(function(){
            activeContentHeight += $(this).innerHeight();
        });
        // activeContentHeight-=8;
        
        if(reportsHeight<507){
            reportsHeight=507;
        }
        if(activeContentHeight > reportsHeight-180){
            activeContentHeight = reportsHeight-180;
        }
        $("#reportsContent, #reportFilters").css("height", reportsHeight + "px");
        $(".activeContent.contentTable").css("height", activeContentHeight + "px").css("display","block");
    }
    resizeReports();
    
    resizeSubmitData = function(){
        submitDataHeight = $(window).innerHeight()-186;
        if(submitDataHeight<432){
            submitDataHeight=432;
        }
        $("#submitDataContent").css("height", submitDataHeight + "px");
        $("#submitDataFilters").css("height", submitDataHeight + 75 + "px");
        $("#submitDataSection").css("height", submitDataHeight + 136 + "px");
    }
    resizeSubmitData();
    
    refreshDropdowns = function(select_id){
        switch(select_id){
            case "l0_select":
                $("#l1, #l2, #l3, #l4, #l5").fadeOut(200);
                $("#l1_select option.none, #l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                if( $("#l0_select").val() != "na"){
                    $("#l1").fadeIn(200);
                }
                $("#l1_select, #l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l1_select":
                $("#l2, #l3, #l4, #l5").fadeOut(200);
                $("#l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", "selected");
                if( $("#l1_select").val() != "na"){
                    $("#l2").fadeIn(200);
                }
                $("#l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l2_select":
                $("#l3, #l4, #l5").fadeOut(200);
                $("#l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                if( $("#l2_select").val() != "na"){
                    $("#l3").fadeIn(200);
                }
                $("#l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l3_select":
                if(highest_level>3){
                    $("#l5").fadeOut(200);
                    $("#l4_select option.none, #l5_select option.none").attr("selected", true);
                    if( $("#l3_select").val() != "na"){
                        $("#l4").fadeIn(200);
                    }
                }
                break;
            case "l4_select":
                if(highest_level>4){
                    $("#l5").fadeOut(200);
                    $("#l4_select option.none, #l5_select option.none").attr("selected", true);
                    if( $("#l3_select").val() != "na"){
                        $("#l4").fadeIn(200);
                    }
                }
                break;
            case "l5_select":
                break;
            default:
                $("#l1, #l2, #l3, #l4, #l5").fadeOut(200);
                $("#l0_select option.none, #l1_select option.none, #l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                $("#l0_select, #l1_select, #l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                
        }
    }
    
    setLevel = function(){
        var l_level=0;
        if($("#l5_select-button").is(":visible")){
            switch($("#l5_select option:selected").val()){
                case "na":
                    l_level=4;
                    break;
                default:
                    l_level=5;
            }
        } else if ($("#l4_select-button").is(":visible")){
            switch($("#l4_select option:selected").val()){
                case "na":
                    l_level=3;
                    break;
                default:
                    l_level=4;
            }
        } else if ($("#l3_select-button").is(":visible")){
            switch($("#l3_select option:selected").val()){
                case "na":
                    l_level=2;
                    break;
                default:
                    l_level=3;
            }
        } else if ($("#l2_select-button").is(":visible")){
            switch($("#l2_select option:selected").val()){
                case "na":
                    l_level=1;
                    break;
                default:
                    l_level=2;
            }
        } else if ($("#l1_select-button").is(":visible")){
            switch($("#l1_select option:selected").val()){
                case "na":
                    l_level=0;
                    break;
                default:
                    l_level=1
            }
        }
        reassignRatings(l_level);
    }
    reassignRatings = function(l_level){
        switch(l_level){
            case 0:
                $(".geoName").html($("#l0_select").val());
                $(".geoType").html("Country <span>In</span>");
                $(".year").html("2010");
                $("#subGeoReported").html("8 Provinces Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $("#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; " + $("#l0_select").val()).show();
                $(".communeOnly").fadeOut(200);
                $("#iconsKey input").hide();
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".provinceWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 1:
                $(".geoName").html($("#l1_select").val());
                $(".geoType").html("Province <span>In</span>");
                $(".year").html("2010");
                $("#l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; " + $("#l1_select").val()).show();
                $("#subGeoReported").html("3 Districts Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $(".communeOnly").fadeOut(200);
                $("#iconsKey input").hide();
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".districtWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 2:
                $(".geoName").html($("#l2_select").val());
                $(".geoType").html("District <span>In</span>");
                $(".year").html("2010");
                $("#l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(1); refreshDropdowns(\"l1_select\");'>" + $("#l1_select").val() + "</a>").show();
                $("#l2_breadcrumb").html(" &raquo; " + $("#l2_select").val()).show();
                $("#subGeoReported").html("8 Communes Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $(".communeOnly").fadeOut(200);
                $("#iconsBlocker").hide();
                $("#iconsKey input").show();
                $("#mapKey #iconsKey label").css("color", "#565656");
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".communeWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 3:
                $(".geoName").html($("#l3_select").val());
                $(".geoType").html("Commune <span>In</span>");
                $(".year").html("2010");
                $(".communeOnly").show();
                $(".noCommune").hide();
                $("#qualityCommunes").html("Last Data Collected on 7/3/2011 by Tina Pham");                
                $("#l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(1); refreshDropdowns(\"l1_select\");'>" + $("#l1_select").val() + "</a>").show();
                $("#l2_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(2); refreshDropdowns(\"l2_select\");'>" + $("#l2_select").val() + "</a>").show();
                $("#l3_breadcrumb").html(" &raquo; " + $("#l3_select").val()).show();
                $("#iconsBlocker").hide();
                $("#iconsKey input").show();
                $("#mapKey #iconsKey label").css("color", "#565656");
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow");
                break;
            case 4:
                break;
            case 5:
                break;
        }
        updateChart(l_level, true);
        updateChartDropdown(l_level);
    }
    
    updateChart = function(l_level, ratingBlocksBoolean){        
        var medianTotal=0;
        ratingsObject = [
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)]
        ];
        // for loop to add css properties to chart in drawer
        for(var i=0; i<ratingsObject.length; i++){
            $("#visRange" + i + " .rightBox, #visRange" + i + " .leftBox").show();

            ratingsObject[i].sort();
            //set left margin
            $("#visRange" + i).css("left", (58*(ratingsObject[i][0]-1)) + "px");
            //set width of the range
            $("#visRange" + i).css("width", (58*(ratingsObject[i][ratingsObject[i].length-1] - ratingsObject[i][0])) + "px")
        
            //set median values
            var medianIndex = ratingsObject[i].length/2.0;
            switch(medianIndex%1){
                case 0:
                    median = ((ratingsObject[i][medianIndex] + ratingsObject[i][medianIndex-1])/2.0);
                    break;
                default:
                    median = (ratingsObject[i][Math.floor(medianIndex)]);
                    break;
            }
        
            // set difference variable so that we'll be able to specify the dot's position
            var medianDifference = median - ratingsObject[i][0];
        
            // position the median dot/circle
            $("#visRange" + i + " .medianDot").css("left", (medianDifference*58) + "px");
            if(median == ratingsObject[i][0]){
                $("#visRange" + i + " .leftBox").hide();
            }
            if(median == ratingsObject[i][ratingsObject[i].length - 1]){
                $("#visRange" + i + " .rightBox").hide();
            }
            medianTotal+=median;
        }
        var bgcolor;
        var ddThumb;
        // median = Math.round(medianTotal/ratingsObject.length); // We will ultimately be doing something like this, but since rounding a bunch of randomly generated numbers almost always ends up with a median value of 3, I'm using the following:
        median = Math.ceil(median);
        if(ratingBlocksBoolean){
            updateRatingBlocks(l_level, median);
        }
    }
    var updateRatingBlocks = function(l_level, median){
        switch(median){
            case 1:
                bgcolor = "#ff5121";
                ddThumb = "one";
                break;
            case 2:
                bgcolor = "#f4961c";
                ddThumb = "two";
                break;
            case 3:
                bgcolor = "#d6b317";
                ddThumb = "three";
                break;
            case 4:
                bgcolor = "#77b82e";
                ddThumb = "four";
                break;
            case 5:
                bgcolor = "#059346";
                ddThumb = "five";
                break;
            default:
                bgcolor = "#999";
        }
        $("#mainRating, #indicator").css("background-color", bgcolor);
        $("#mainRating, #indicator").text(median);
        $("#mainRating, #indicator").show();
        $("#l" + l_level + "_level option:selected").each(function(){ $(this).removeClass("one two three four five"); });
        $("#l" + l_level + "_level option:selected").addClass(ddThumb);        
    }
    var updateChartDropdown = function(l_level){
        var optionsText;
        
        for(var i=l_level; i>=0; i--){
            switch(i){
                case l_level:
                    optionsText += '<option value="' + i + '" selected="selected">Current Location</option>';
                    break;
                default:
                    optionsText += '<option value="' + i + '">' + $("#l" + i + "_select option:selected").html() + '</option>';
            }
        }
        
		$("#chartSwitcher").html(optionsText);
		$("#chartSwitcher").selectmenu("destroy").selectmenu({
    	    style: "popup",
    	    maxHeight:280,
    	    width:125,
    	    menuWidth:125
    	});
    }
    
    
    //function to open/close the drawer
    var drawerSlide = function(){
        switch(drawerOpen){
            case true:
                $(".hidden").hide('slow');
                $("#show-hide").html("<span class='arrow'>&uarr;</span> SHOW MORE");
                $("#risingTab").css("background-image","url('img/assets/openTabPng8.png')");
                $(".activeWindow").fadeIn(300);
                drawerOpen = false;
                if(subGeoShowing){ showSubGeo(); }
                break;
            case false:
                $("#drawerInside").show('slow');
                $("#drawerInside").data("fade", setTimeout(function(){ 
                    $("#resilienceSummary, #drawerQuickActions, #indicatorRatingChart, #browseOtherRegions, #dataBreakdown").fadeIn(500);
                    $(".communeOnly").hide(); 
                }, 500));
                $("#show-hide").html("<span class='arrow'>&darr;</span> SHOW LESS");
                $("#risingTab").css("background-image","url('img/assets/closeTabPng8.png')");
                $(".activeWindow").fadeOut(300);
                drawerOpen = true;
                break;
        }
    };    
    reassignRatings();
    
    //analysis section code for the timeline slider
    var percentageIncrement = 100/(timelineMax - timelineMin);
    var startingPoint;
    for(var i=timelineMin; i<=timelineMax; i++){
        if(i%5==0){
            startingPoint=i;
            break;
        }
    }
    for(var i=startingPoint; i<=timelineMax; i+=5){
        $("#analysisTimelineLabels").append("<div style='left:" + (i-timelineMin)*percentageIncrement + "%;'><span>&#124;</span></br />" + i + "</div>")
    }    
    
    $("#analysisTimeline").slider({
		range: true,
		min: timelineMin,
		max: timelineMax,
        values: [ 1990, parseInt($("#drawerTop .year").text()) ],
        slide: function( event, ui ) {
            $("#analysisDrawerTop .year").html(ui.values[0] + "&ndash;" + ui.values[1]);
            $(".analysisLowerYearHidden").html(ui.values[0]);
            $(".analysisUpperYearHidden").html(ui.values[1]);
        }
    });
    
    $("#submitIndicators, #submitReports").click(function(){
        if(!$(this).hasClass("active")){
            $("#submissionToggle .active").removeClass("active");
            $(this).addClass("active");
            if($("#submitDataFilters").css("background-color")=="#f7941d"){
                $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
            }
            if($("#submitDataFooter .reviewSubmissionButton").is(":visible")){
                $("#submitDataFooter .reviewSubmissionButton, mark").fadeOut(300);
            }
            switch(this.id){
                case "submitIndicators":
                    $("#indicatorsSubmissionViews").fadeIn(300);
                    $("#dataAndReportsSubmissionViews").fadeOut(300);
                    setTimeout(function(){
                        $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
                        $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
                        $("#dataSubmissionRegion1 input").attr("disabled", false).attr("checked", false);
                        numberSubmissions = 2;
                        numberSubmissionsDeleted = 0;
                        $("#dataAndReportsSubmissionViews .dataUploadContainer").show(300);
                        $(".fileType").show(300);
                        $(".loadingErrorView").hide();
                        $(".dataSubmissionRegion input:radio").each(function(){
                                $(this).parent().removeAttr("style");
                        });
                    },300);
                    break;
                case "submitReports":
                    
                    $("#indicatorsSubmissionViews").fadeOut(300);
                    $("#dataAndReportsSubmissionViews").fadeIn(300);
                    setTimeout(function(){
                        $("#indicatorsSubmissionViews").children("div").hide();
                        $("#submitDataContent .indicatorsStart").show();
                    },300);
                    break;
            }
        }else{
            switch(this.id){
                case "submitIndicators":
                    $("#indicatorsSubmissionViews").children("div").fadeOut(300);
                    $("#submitDataContent .indicatorsStart").fadeIn(300);
                    break;
                case "submitReports":
                    break;
            }
        }
    });
    var sillyProgressBarLoadScript = function(selector){
        setTimeout(function(){
            $(selector).progressbar("value", $(selector).progressbar("value")+1.5);
        },25);
    };
    $("#uploadIndicatorsButton").click(function(){
        $(".loadingView").fadeIn(300);
        $(".indicatorsStart").fadeOut(300);
        $(".loadingView .progressBar").progressbar({
        	value: 0,
        	change: function(event, ui){
        	    sillyProgressBarLoadScript(".loadingView .progressBar");
        	},
        	complete: function(event, ui){
            	if($(".loadingView").is(":visible")){
            	    $(".loadingView").fadeOut(300);
            	    $("#indicatorsSubmissionViews .loadingErrorView").fadeIn(300);
            	}
        	}
        });
        sillyProgressBarLoadScript(".loadingView .progressBar");
        
    });
    $(".loadingErrorView .indicatorsButton").click(function(){
        $(".loadingView").fadeIn(300);
        $("#indicatorsSubmissionViews .loadingErrorView").fadeOut(300);
        $(".loadingView .progressBar").progressbar({
            value:0,
        	change: function(event, ui){
        	    sillyProgressBarLoadScript(".loadingView .progressBar");
        	},
            complete:function(event, ui){
            	if($(".loadingView").is(":visible")){
                    $(".loadingView").fadeOut(300);
                    $("#submitDataContent .reviewIndicatorsView h3").html("Review <span class='currentPage'>1</span> of <span class='totalPages'>3<span>");
                    $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
                        var randomRating = Math.ceil(Math.random()*5);
                        $(this).find("input[value='" + randomRating + "']").attr("checked", true);
                    });
                    $(".reviewIndicatorsView.firstPage").fadeIn(300);
                    $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
                    $("#submitDataFilters h3").hide(300);
                    $("#submissionToggle").hide(300);
                    $("#submitDataFooter mark, #submitDataFooter .reviewNextButton").fadeIn(300);
                }
            }
        })
    });
    $("#submitDataFooter .reviewNextButton").click(function(){
        if(!$(".backButton").is(":visible")){
            $(".backButton").fadeIn(300);
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune.</mark>");
        }else{
            $(".reviewNextButton").hide();
            $(".submitAllButton").show();
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Phu Tam Commune</mark>");
        }
        $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
            var randomRating = Math.ceil(Math.random()*5);
            $(this).find("input[value='" + randomRating + "']").attr("checked", true);
        });
        $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) + 1);
    });
    $("#submitDataFooter .backButton").click(function(){
        if($("#submitDataFooter .reviewNextButton").is(":visible")){
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Hoa Tam Commune.</mark>");
            $(this).hide();
        }else if($("#submitDataContent .dataUploadContainer").is(":visible")){
            numberSubmissionsHidden = 0;
            $("#submitDataContent .dataUploadContainer h4").html("Select data type");
            $("#submitDataContent .dataUploadContainer h3").hide();
            $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
            $("#submitDataFilters h3").show(300);
            $("#submissionToggle").fadeIn(200);
            $("#submitDataFooter .backButton, #submitDataFooter .submitButton, .delete").fadeOut(300);
            setTimeout(function(){
                $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
            },300);
            $(".dataSubmissionRegion input:radio").each(function(){
                if($(this).is(":checked")){
                    $(this).parent().css("left", "");
                }else{
                    $(this).parent().fadeIn(300);
                }
            });
            $(".dataSubmissionRegion").each(function(){
                if($(this).hasClass("mapSubmission") || $(this).hasClass("imageSubmission")){
                    $(this).children(".reviewTitling").fadeOut(300);
                    $(this).animate({"height": "181"},500).css("margin-top","12px");
                    $(this).find(".submitDataThumb").animate({"margin": "49px 0 0 16px"},500);
                }else if($(this).hasClass("otherSubmission") || $(this).hasClass("vcaSubmission")){
                    $(this).children(".reviewTitling").fadeOut(300);
                    $(this).animate({"height": "138"},500).css("margin-top","12px");
                }else if($(this).hasClass("demographicsSubmission")){
                    if($(this).children(".loadingErrorView").css("display") != "none"){
                        $(this).animate({"height": "178"},500).css("margin-top","12px");
                    }else{
                        $(this).animate({"height": "358"},500).css("margin-top","12px");
                        console.log($(this).children(".loadingErrorView").css("display"));
                    }
                    $(this).find(".demoInput, .demographicsLinks").fadeIn(300);
                    $(this).find(".demographicsTable").remove();
                }else if($(this).hasClass("removed")){
                    //do nothing
                }else{
                    $(this).animate({"height":"46px"},500).css("margin-top","12px");
                    $(this).children("submissionContent").empty();
                    $(this).find("input:radio").removeAttr("disabled").parent().removeAttr("style");
                }
                $(".fileType, .labelFile, .remove, .imgDesc, .labelHangRight, .checkHangRight").fadeIn(300);
            });
            setTimeout(function(){ renumberSubmissionRegions("restore"); }, 500);
        }else{
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune</mark>");
            $("#submitDataFooter .submitAllButton").fadeOut();
            setTimeout(function(){
                $("#submitDataFooter .reviewNextButton").fadeIn();
            },300);
        }
        $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) - 1);
        $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
            var randomRating = Math.ceil(Math.random()*5);
            $(this).find("input[value='" + randomRating + "']").attr("checked", true);
        });
    });
    $("#submitDataFooter .submitAllButton").click(function(){
        $(".reviewIndicatorsView").fadeOut(300);
        $("#indicatorsSubmissionViews .thankyou").fadeIn(300);
        $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300)
        setTimeout(function(){
            $("#submitDataFooter .submitMoreButton").fadeIn(300);
        },300);
    });
    $("#submitDataFooter .submitMoreButton").click(function(){
        $(".thankyou, #submitDataFooter .submitMoreButton").fadeOut(300);
        $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
        $("#submitDataFilters h3").fadeIn(300);
        $("#submissionToggle").fadeIn(300);
        $("#submitDataContent .dataUploadContainer h4").html("Select data type");
        $("#submitDataContent .dataUploadContainer h3, .delete, .reviewTitling").hide();
        if($("#indicatorsSubmissionViews").is(":visible")){
            $("#submitDataContent .indicatorsStart").fadeIn(300);
            $("#submitDataContent .indicatorsStart p").filter(":first").show();
        }else{
            $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
            $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
            $("#dataSubmissionRegion1 input").attr("disabled", false).attr("checked", false);
            numberSubmissions = 2;
            numberSubmissionsDeleted = 0;
            // $(".dataSubmissionRegion.generic").removeAttr("style")
            $("#dataAndReportsSubmissionViews .dataUploadContainer").fadeIn(300);
            $(".fileType, .labelFile, .remove, .imgDesc, .fakePlaceholder, .labelHangRight, .checkHangRight").fadeIn(300);
            $(".dataSubmissionRegion input:radio").each(function(){
                    $(this).parent().removeAttr("style");
            });
        }
    });
    $("#submitOnlineButton").click(function(){
        if(!$(this).hasClass("disabled")){ //if not disabled, then load the indicator form
            $("#submitDataContent .submitIndicatorsForm input").attr("checked", false);
            $("#submitDataContent .submitIndicatorsForm, #submitDataFooter mark").fadeIn(300);
            $("#submitDataContent .indicatorsStart").fadeOut(300);
            $("#submitDataFooter .reviewSubmissionButton").addClass("disabled").fadeIn(300);
        }
    });
    $("#submitDataFooter .reviewSubmissionButton").click(function(){
        if($("#l3_data").val() != "na"){
            var lowestDD = $("#l3_data option:selected").html() + " Commune.";
        }else if($("#l2_data").val() != "na"){
            var lowestDD = $("#l2_data option:selected").html() + " District.";
        }else if($("#l1_data").val() != "na"){
            var lowestDD = $("#l1_data option:selected").html() + " Province.";
        }else if($("#l0_data").val() != "na"){
            var lowestDD = $("#l1_data option:selected").html() + " Country.";
        }
        if($("#submitDataContent .submitIndicatorsForm").is(":visible")){
            $("#submitDataContent .submitIndicatorsForm h3").html("Review");
            $("#submitDataContent .submitIndicatorsForm h4").filter(":first").html("You are about to submit indicator ratings for <mark>Hao Tam Commune</mark>");//this is where you'll want to insert from drop-downs if manually entered or from file if uploaded.
            $(".submitIndicatorsForm h3, .submitIndicatorsForm h4").fadeIn(300);
            $("#submitDataFooter .reviewSubmissionButton, .submitIndicatorsForm .indicatorLabels div").fadeOut(300);
            $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
            $("#submitDataFilters h3").hide(300);
            $("#submissionToggle").fadeOut(200);
            setTimeout(function(){
                $("#submitDataFooter .submitButton").fadeIn(300);
            },300);
        }else if($("#submitDataContent .dataUploadContainer").is(":visible")){
            if(!$(this).hasClass("disabled")){
                var reviewCount=0
                $(".dataSubmissionRegion").each(function(){
                    //this is a lot, so for clarity: if it is a map or image file AND the checkbox is checked...
                    if($(this).hasClass("mapSubmission") && $(this).find(".checkHangRight").is(":checked") || $(this).hasClass("imageSubmission") && $(this).find(".checkHangRight").is(":checked")){
                        $(this).children(".reviewTitling").html($(this).find(".imgDesc").val()).fadeIn(300);
                        $(this).animate({"height": "141px"},500);
                        $(this).find(".submitDataThumb").animate({"margin": "40px 0 0 16px"},500);
                        reviewCount++;
                    //likewise: if it is a VCA or other report AND the checkbox is checked...
                    }else if($(this).hasClass("otherSubmission") && $(this).find(".checkFile").is(":checked") || $(this).hasClass("vcaSubmission") && $(this).find(".checkFile").is(":checked")){
                        $(this).children(".reviewTitling").html($(this).find(".labelFile").html()).fadeIn(300);
                        $(this).animate({"height": "46px"},500);
                        $(this).find(".delete").css("left", 285 + $(this).find(".reviewTitling").innerWidth() + "px");
                        reviewCount++;
                    }else if($(this).hasClass("demographicsSubmission")){
                        $(this).find(".demoInput, .demographicsLinks").fadeOut(300);
                        $(this).children(".submissionContent").append("<table class='demographicsTable'><tbody></tbody></table>");
                        $(this).find(".demoField").each(function(){
                            if($(this).val() != "" && $(this).siblings(".demoLabel").hasClass("tallRow")){
                                $(this).parent().siblings(".demographicsTable").children("tbody").append("<tr class='tallRow'><td class='demoLabel'>" + $(this).siblings(".demoLabel").html() + "</td><td class='demoStatistic'><div>" + $(this).val() + "</div></td><td class='demoSource'><div>Data Source: " + $(this).siblings(".sourceField").val() + "</div></td></tr>");
                            }else if($(this).val() != ""){
                                $(this).parent().siblings(".demographicsTable").children("tbody").append("<tr><td class='demoLabel'>" + $(this).siblings(".demoLabel").html() + "</td><td class='demoStatistic'><div>" + $(this).val() + "</div></td><td class='demoSource'>Data Source: " + $(this).siblings(".sourceField").val() + "</td></tr>");
                            }
                        });
                        var numDemoRows = $(this).find("tr").length;
                        if(numDemoRows != 0){
                            var demoDivHeight = 255 - (7 - numDemoRows)*25 + "px";
                            $(this).animate({"height": demoDivHeight },500);
                            $(this).find(".demographicsTable").fadeIn(300);
                            reviewCount++;
                        }else{
                            $(this).animate({"height":"0"},500).animate({"margin-top":"0"});
                            numberSubmissionsHidden++;
                        }
                    // Any unused section that is NOT a generic section/div used for cloning gets shrunk to nothing.
                    }else if(!$(this).hasClass("generic")){
                        $(this).animate({"height":"0"},500).animate({"margin-top":"0"});
                        if($(this).hasClass("mapSubmission") || $(this).hasClass("imageSubmission") || $(this).hasClass("otherSubmission") || $(this).hasClass("vcaSubmission")){
                            numberSubmissionsHidden++;
                        }
                    }
                }); //end of loop through sections
                if(reviewCount>1){
                    var reviewCountReports = "reports";
                }else{ 
                    var reviewCountReports = "report"
                }
                $(".fileType, .labelFile, .remove, .imgDesc, .fakePlaceholder, .labelHangRight, .checkHangRight").fadeOut(300);
                $("#submitDataContent .dataUploadContainer h3").fadeIn(300)
                $("#submitDataContent .dataUploadContainer h4").filter(":first").html("You are about to submit <span class='reviewCount'>" + reviewCount + "</span> <span class='reviewCountReports'>" + reviewCountReports + "</span> for <mark>" + lowestDD + "</mark>"); //I've used L3 for the mockup. Ultimately, you'll need to extend this to grab the lowest active level
                $("#submitDataContent .dataUploadContainer h3").fadeIn(300);
                $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
                $("#submitDataFilters h3").hide(300);
                $("#submissionToggle").fadeOut(200);
                $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeOut(300);
                setTimeout(function(){
                    $("#submitDataFooter .backButton").fadeIn(300);
                    $("#submitDataFooter .submitButton").fadeIn(300);
                    $(".delete").fadeIn(300);
                },300);
                setTimeout(function(){ renumberSubmissionRegions("restore"); }, 500);
                $(".dataSubmissionRegion input:radio").each(function(){
                    if($(this).is(":checked")){
                        var regionID = $(this).parent().parent().attr("id");
                        var regionSelector = "#" + regionID;
                        $(this).parent().animate({"left": "146px"},500);
                    }else{
                        $(this).parent().fadeOut(300);
                    }
                });
            } else{
                //do nothing
            }
        }
    });
    $(".submitIndicatorsForm input").change(function(){
        if($(".submitIndicatorsForm input:radio:checked").length==10){
            $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
        }
    });
    $("#submitDataFooter .submitButton").click(function(){
        if($("#submitDataContent .submitIndicatorsForm").is(":visible")){
            $("#submitDataContent .submitIndicatorsForm").fadeOut(300);
            $("#indicatorsSubmissionViews .thankyou").fadeIn(300);
            $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300);
            setTimeout(function(){
                $("#submitDataFooter .submitMoreButton").fadeIn(300);
                $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                $(".submitIndicatorsForm h3, .submitIndicatorsForm h4").hide();
                $(".submitIndicatorsForm .indicatorLabels div").show();            
            },300);
        }else if($("#submitDataContent .dataUploadContainer").is(":visible")){
            $("#submitDataContent .dataUploadContainer").fadeOut(300);
            $("#dataAndReportsSubmissionViews .thankyou").fadeIn(300);
            $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300);
            setTimeout(function(){
                $("#submitDataFooter .submitMoreButton").fadeIn(300);
            },300);
        }
    });
    var testRequiredFields = function(){
        var tempDisablingBool = false;
        var filledFields = false;
        var demographicsBypass = false; //there must be a more elegant way of doing this... but this is what I came up with...
        $(".imgDesc").each(function(){
            if($(this).val() == "" && $(this).siblings(".checkHangRight").is(":checked")){
                // console.log("first if!");
                tempDisablingBool = true;
                return false;
            }
        });
        if(tempDisablingBool){ return true; }
        $(".demoField").each(function(){
            if($(this).val() != "" && $(this).siblings(".sourceField").val() == ""){
                // console.log("second if!");
                tempDisablingBool = true;
                return false;
            }else if($(this).val() != ""){
                // console.log("second-and-a-half if");
                filledFields = true;
            }
        });
        if(tempDisablingBool){ return true; }
        if(!$(".mapSubmission").is(":visible") && !$(".imageSubmission").is(":visible") && !$(".otherSubmission").is(":visible") && !filledFields && !$(".vcaSubmission").is(":visible")){
            // console.log("third if!");
            return true;
        }
        // var tempRegionCounter = 0;
        $(".dataSubmissionRegion").each(function(){
            if($(this).hasClass("mapSubmission") || $(this).hasClass("imageSubmission") || $(this).hasClass("otherSubmission") || $(this).hasClass("vcaSubmission") ){
                if($(this).find("input:checkbox").is(":checked") && $(this).innerHeight() != 0){
                    // console.log("fourth if!");
                    demographicsBypass = true;
                    return false;
                }
            }else if($(this).hasClass("demographicsSubmission")){
                $(this).find(".demoField").each(function(){
                    if($(this).val() != ""){
                        // console.log("fifth if!");
                        filledFields = true;
                        return false;
                    }
                });
            }
        });
        if(!filledFields && !demographicsBypass){
            // console.log("sixth if!");
            tempDisablingBool = true;
        }
        return tempDisablingBool;
        // console.log("missed them all!");
    }
    var bindPlaceholderEvents = function(regionSelector, type){
        switch(type){
            case "image":
                $(regionSelector + " .fakePlaceholder").click(function(){
                    $(this).hide();
                    $(this).siblings(".imgDesc").focus();
                });
                $(regionSelector + " .imgDesc").focus(function(){
                    $(this).siblings(".fakePlaceholder").hide();
                });
                $(regionSelector + " .imgDesc").blur(function(){
                    if($(this).val() == ""){
                        $(this).siblings(".fakePlaceholder").show();
                    }
                });
                $(regionSelector + " .imgDesc").change(function(){
                    if($(this).val() == "" || $(".loadingErrorView").is(":visible") || testRequiredFields()){
                        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    }else{
                        $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                    }
                });
                $(".checkHangRight").change(function(){
                    if(testRequiredFields()){
                        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    }else{ $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled"); }
                    //     var tempBoolean = false;
                    //     $(".dataSubmissionRegion").each(function(){
                    //         if($(this).hasClass("demographicsSubmission")){
                    //             var demoBool = true;
                    //             $(this).find(".demoField").each(function(){
                    //                 if($(this).val() != "" && $(this).siblings(".sourceField").val() == ""){
                    //                     demoBool = false;
                    //                 }
                    //                 if(demoBool && $(this).val() != ""){
                    //                     demoBool = true;
                    //                 }
                    //             });
                    //         }
                    //         //this is a lot, so for clarity: if it is a map or image file AND the checkbox is checked... OR a report and the checkbox is checked
                    //         if($(this).hasClass("mapSubmission") && $(this).find(".checkHangRight").is(":checked") || $(this).hasClass("imageSubmission" && $(this).find(".checkHangRight").is(":checked")) || $(this).hasClass("otherSubmission") && $(this).find(".checkFile").is(":checked") || $(this).hasClass("vcaSubmission") && $(this).find(".checkFile").is(":checked") || $(this).hasClass("demographicsSubmission") && demoBool){
                    //             tempBoolean = true;
                    //         }
                    //     });
                    //     if(tempBoolean){
                    //         $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                    //     }else{
                    //         $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    //     }
                    // }
                    
                    if($(this).is(":checked")){
                        $(this).parent().siblings().children("input:radio").attr("disabled", true);
                        $(this).parent().siblings(".mapOption, .imageOption, .otherOption, .demoOption, .VCAOption").css("color", "#999");
                    }else{
                        $(this).parent().siblings().children("input:radio").attr("disabled", false);                        
                        $(this).parent().siblings(".mapOption, .imageOption, .otherOption, .demoOption, .VCAOption").css("color", "#333");
                    }
                });
                break;
            case "report":
                $(".checkFile").change(function(){
                    if(testRequiredFields()){
                        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    }else{ $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                        // var tempBoolean = false;
                        // $(".dataSubmissionRegion").each(function(){
                        //     if($(this).hasClass("demographicsSubmission")){
                        //         var demoBool = true;
                        //         $(this).find(".demoField").each(function(){
                        //             if($(this).val() != "" && $(this).siblings(".sourceField").val() == ""){
                        //                 demoBool = false;
                        //             }
                        //             if(demoBool && $(this).val() != ""){
                        //                 demoBool = true;
                        //             }
                        //         });
                        //     }
                        //     //this is a lot, so for clarity: if it is a map or image file AND the checkbox is checked...
                        //     if($(this).hasClass("mapSubmission") && $(this).find(".checkHangRight").is(":checked") || $(this).hasClass("imageSubmission" && $(this).find(".checkHangRight").is(":checked")) || $(this).hasClass("otherSubmission") && $(this).find(".checkFile").is(":checked") || $(this).hasClass("vcaSubmission") && $(this).find(".checkFile").is(":checked") || $(this).hasClass("demographicsSubmission") && demoBool){
                        //         tempBoolean = true;
                        //     }
                        // });
                        // if(tempBoolean){
                        //     $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                        // }else{
                        //     $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                        // }
                    }
                    
                    if($(this).is(":checked")){
                        $(this).parent().siblings().children("input:radio").attr("disabled", true);
                    }else{
                        $(this).parent().siblings().children("input:radio").attr("disabled", false);                        
                    }
                });
                break;
            case "demographics":
                $(regionSelector + " .demoField").change(function(){
                    if($(this).val() != ""){
                        $(this).siblings(".sourceLabel").children("mark").show();
                        $(this).siblings(".sourceField").addClass("required").attr("placeholder", "e.g. Census 2010");
                    }else{
                        $(this).siblings(".sourceLabel").children("mark").hide();
                        $(this).siblings(".sourceField").removeClass("required");
                    }
                    if(testRequiredFields()){
                        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    }else{
                        $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                    }
                });
                $(regionSelector + " .sourceField").change(function(){
                    if(testRequiredFields()){
                        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    }else{
                        $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                    }
                });
        }        
    }
    $(".dataSubmissionRegion input:radio").change(function(){
        var currentRegionID = $(this).parent().parent().attr('id');
        var currentRegionSelector = "#" + currentRegionID;
        $(currentRegionSelector).removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission");
        inputValue = $(this).val()
        $(currentRegionSelector).addClass(inputValue + "Submission");
        $(currentRegionSelector + " input:radio").attr("disabled", true);
        $(currentRegionSelector + " .mapOption, " + currentRegionSelector + " .imageOption, " + currentRegionSelector + " .otherOption, " + currentRegionSelector + " .demoOption, " + currentRegionSelector + " .VCAOption").css("color", "#999");
        switch(inputValue){
            case "map":
                var dataSubmission = "<img class='submitDataThumb' src='img/map1thumb.jpg' alt='Map thumbnail' /><input class='checkHangRight' id='imageFor" + currentRegionID + "' type='checkbox' checked><label class='labelHangRight' for='imageFor" + currentRegionID + "'>dummyfilename.jpg</label><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><input type='text' class='imgDesc' id='descFor" + currentRegionID + "\' autocomplete='off' /><div class='fakePlaceholder requiredField'><mark>*</mark>Add a description</div><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>";
                var regionHeight = 181;  //ultimately, this should be determined by the image height when sized at 100px wide
                break;
            case "image":
                var dataSubmission = "<img class='submitDataThumb' src='img/map1thumb.jpg' alt='Map thumbnail' /><input class='checkHangRight' id='imageFor" + currentRegionID + "' type='checkbox' checked><label class='labelHangRight' for='imageFor" + currentRegionID + "'>dummyfilename.jpg</label><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><input type='text' class='imgDesc' id='descFor" + currentRegionID + "\' autocomplete='off' /><div class='fakePlaceholder requiredField'><mark>*</mark>Add a description</div><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>";
                var regionHeight = 181;  //ultimately, this should be determined by the image height when sized at 100px wide
                break;
            case "other":
                var dataSubmission = "<div class='fileType'><mark>.PDF and Word Document (.doc/.docx) only</mark></div><input class='checkFile' id='imageFor" + currentRegionID + "' type='checkbox' checked><label class='labelFile' for='imageFor" + currentRegionID + "'>dummyfilename.pdf</label><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>";
                var regionHeight = 138;
                break;
            case "demographics":
                var dataSubmission = '';
                var regionHeight = 358;
                break;
            case "vca":
                var dataSubmission = "<div class='fileType'><mark>.PDF and Word Document (.doc/.docx) only</mark></div><input class='checkFile' id='imageFor" + currentRegionID + "' type='checkbox' checked><label class='labelFile' for='imageFor" + currentRegionID + "'>dummyfilename.pdf</label><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>";
                var regionHeight = 138;
                break;
        }
        if($(currentRegionSelector + " .submissionContent").is(":visible")){
            $(currentRegionSelector + " .submissionContent").fadeOut(300);
        }
        switch(inputValue){
            case "map":
            case "image":
            case "other":
            case "vca":
                $(currentRegionSelector).animate({ "height": "128px" }, 300);
                $(currentRegionSelector + " .uploadView").fadeIn(300);
                //if this is the first upload in the region, scroll down to the next available region. Otherwise, you're editing, so you won't likely want the auto-scrolling
                if(!$(currentRegionSelector + " .submissionContent").is(":visible")){ 
                    $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
                }
                $(currentRegionSelector + " .progressBar").progressbar({
                	value: 0,
                	change: function(event, ui){
                        switch($(currentRegionSelector + " .progressBar").progressbar("value")){
                            case 100:
                                break;
                            default:
                                sillyProgressBarLoadScript(currentRegionSelector + " .progressBar");
                        }
                    },
                	complete: function(event, ui){
                        if(!$(currentRegionSelector).hasClass("loaded") && $("#" + currentRegionID + " .uploadView").is(":visible")){
                    	    $(currentRegionSelector).addClass("loaded");
                        	setTimeout(function(){
                                $(currentRegionSelector + " .progressBar").progressbar("destroy");
                        	    $(".dataSubmissionRegion.generic").clone(true, true).appendTo("#newSubmissionRegions");
                        	    var newRegionID = "dataSubmissionRegion" + numberSubmissions;
                        	    var newRegionSelector = "#" + newRegionID;
                        	    $("#newSubmissionRegions .dataSubmissionRegion.generic").removeClass("generic").attr("id", newRegionID).fadeIn(300);
                        	    var submissionsDifference = numberSubmissions - numberSubmissionsDeleted;
                        	    if(submissionsDifference<10){ submissionsDifference = "0" + submissionsDifference; }
                        	    $(newRegionSelector + " h5").text("DATA/REPORT " + submissionsDifference);
                        	    $(newRegionSelector).children("div").children("input").each(function(){
                        	        $(this).attr("id", this.id + numberSubmissions);
                                    $(this).attr("name", $(this).attr("name") + numberSubmissions);
                        	    });
                        	    $(newRegionSelector).children("div").children("label").each(function(){
                        	        $(this).attr("for", $(this).attr("for") + numberSubmissions);
                        	    });
                        	    $(newRegionSelector + ".cancel").attr("href", "javascript:$('#dataSubmissionRegion" + numberSubmissions + " .uploadView').fadeOut(200); $('#dataSubmissionRegion" + numberSubmissions + "').animate({'height': '47px'},300);")
                                numberSubmissions++;
                                $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
                        	}, 500);
                        }else{
                            setTimeout(function(){ $("#" + currentRegionID + " .progressBar").progressbar("destroy"); },300);
                        }
                        $(currentRegionSelector).animate({ "height": regionHeight + "px" }, 300);
                	    $(currentRegionSelector + " .uploadView").fadeOut(300);
                    	setTimeout(function(){
                    	    $(currentRegionSelector + " .submissionContent").html(dataSubmission).fadeIn(300);
                    	    if(inputValue=="map" || inputValue=="image"){
                    	        bindPlaceholderEvents(currentRegionSelector, "image");
                    	        $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    	    }else if(inputValue=="other" || inputValue=="vca"){
                    	        bindPlaceholderEvents(currentRegionSelector, "report");
                    	    }

                        	if(numberSubmissions==2){
                        	    $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
                        	}
                            if(!testRequiredFields()){
                                $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                            }
                    	},300);
                	}
                }, 300);
                sillyProgressBarLoadScript("#" + currentRegionID + " .progressBar");
                break;
            case "demographics":  // HERE IS WHERE I HAVE INCLUDED LINKS TO TEMPLATE DEMOGRAPHIC DATA FILE AND GUIDE TO UPLOADING FILES
                var labelsArray = ["Population", "Male", "Female", "Over 60", "Under 5", "Households", "Households below <br />poverty line"];
                $(currentRegionSelector).animate({ "height": regionHeight + "px" }, 500);
                if(!$(currentRegionSelector + " .submissionContent").is(":visible")){ 
                    $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
                }
                $(currentRegionSelector + " .submissionContent").html("<mark class='demographicsLinks'><strong>Fill out online below or <a href='javascript:demographicsLoader(\"" + currentRegionSelector + "\");' title='Upload CSV document'>Upload .CSV</a></strong>&nbsp;&nbsp;&nbsp;<a href='demographicsTemplate.csv' title='Download the demographics submission template file' target='_blank'>Download .CSV formatted Template</a>&nbsp;&nbsp;&nbsp;&#124;&nbsp;&nbsp;&nbsp;<a href='uploadGuide.pdf' target='_blank' title='Download the guidelines for uploading files'>Guide</a></mark><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>");
                for(var i=0; i<7; i++){
                    $(".demoInput.generic").clone(true, true).appendTo(currentRegionSelector + " .submissionContent");
        	        $(currentRegionSelector + " .submissionContent .generic").removeClass("generic").children().each(function(){
        	            var sectionNumber = currentRegionID.replace("dataSubmissionRegion","");
        	            if($(this).is("input")){
        	                idValue = this.id + i;
        	                $(this).attr("id", idValue + "_" + sectionNumber);
        	            }else if($(this).is("label")){
        	                var forValue = $(this).attr("for") + i;
        	                $(this).attr("for", forValue)
        	                if($(this).hasClass("demoLabel")){
        	                    $(this).html(labelsArray[i]);
        	                }else{
        	                    $(this).css("top","7px");
        	                }
        	                if(i==6){
        	                    $(this).addClass("tallRow");
        	                }
        	            }
        	        });
                }
                if(!$(currentRegionSelector).hasClass("loaded")){
            	    $(currentRegionSelector).addClass("loaded");
                    setTimeout(function(){
                	    var newRegionID = "dataSubmissionRegion" + numberSubmissions;
                	    var newRegionSelector = "#" + newRegionID;
                	    $(".dataSubmissionRegion.generic").clone(true, true).appendTo("#newSubmissionRegions");
                	    $("#newSubmissionRegions .dataSubmissionRegion.generic").removeClass("generic").attr("id", newRegionID).fadeIn(300);
                	    var submissionsDifference = numberSubmissions - numberSubmissionsDeleted;
                	    if(submissionsDifference<10){ submissionsDifference = "0" + submissionsDifference; }
                	    $(newRegionSelector + " h5").text("DATA/REPORT " + submissionsDifference);
                	    $(newRegionSelector).children("div").children("input").each(function(){
                	        $(this).attr("id", this.id + numberSubmissions);
                            $(this).attr("name", $(this).attr("name") + numberSubmissions);
                	    });
                	    $(newRegionSelector).children("div").children("label").each(function(){
                	        $(this).attr("for", $(this).attr("for") + numberSubmissions);
                	    });
                	    $(newRegionSelector + ".cancel").attr("href", "javascript:$('#dataSubmissionRegion" + numberSubmissions + " .uploadView').fadeOut(200); $('#dataSubmissionRegion" + numberSubmissions + "').animate({'height': '47px'},300);")
                        numberSubmissions++;
                        $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
                    },500);
                }
                $(currentRegionSelector).animate({ "height": regionHeight + "px" }, 300);
        	    $(currentRegionSelector + " .uploadView").fadeOut(300);
            	setTimeout(function(){
            	    $(currentRegionSelector + " .submissionContent").fadeIn(300);
            	    bindPlaceholderEvents(currentRegionSelector, "demographics");
                    // if(testRequiredFields()){
                    //     $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                    // }else{
                    //     $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                    // }
            	},300);
            	if(numberSubmissions==2){
            	    $("#submitDataFooter .reviewSubmissionButton").addClass("disabled")
            	    $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
            	}
                break;
        }
    });
    demographicsLoader = function(activeRegion){
        $(activeRegion + " .submissionContent").fadeOut(300);
        setTimeout(function(){
            $(activeRegion + " .submissionContent").empty();
            if(testRequiredFields()){
                $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
            }else{
                $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
            }
        },300);
        $(activeRegion + " .uploadView").fadeIn(300);
        $(activeRegion).animate({ "height": "128px" }, 300);
        $(activeRegion + " .progressBar").progressbar({
        	value: 0,
        	change: function(event, ui){
                switch($(activeRegion + " .progressBar").progressbar("value")){
                    case 100:
                        break;
                    default:
                        sillyProgressBarLoadScript(activeRegion + " .progressBar");
                }
            },
        	complete: function(event, ui){
                if(!$(activeRegion).hasClass("loaded") && $(activeRegion + " .uploadView").is(":visible")){
            	    $(activeRegion).addClass("loaded");
                	setTimeout(function(){
                        $(activeRegion + " .progressBar").progressbar("destroy");
                	}, 500);
                }else{
                    setTimeout(function(){ $(activeRegion + " .progressBar").progressbar("destroy"); },300);
                }
        	    $(activeRegion + " .uploadView").fadeOut(300);
        	    $(activeRegion).animate({"height": "178px"},500);
            	if(numberSubmissions==2){
            	    $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
            	}
            	$(activeRegion + " .loadingErrorView .remove").attr("href", "javascript:removeDataSubmitted('" + activeRegion + "');")
            	$(activeRegion + " .errorOptions .fillOnline").attr("href", "javascript:showDemographicsInput('" + activeRegion + "', false);");
            	$(activeRegion + " .errorOptions .uploadAgain").attr("href", "javascript:showDemographicsInput('" + activeRegion + "', true);")
            	$(activeRegion + " .loadingErrorView").fadeIn(300);
        	}
        }, 300);
        sillyProgressBarLoadScript(activeRegion + " .progressBar");  
    }
    showDemographicsInput = function(currentRegionSelector, uploadAgain){
        $(currentRegionSelector + " .loadingErrorView").fadeOut(300);
        var labelsArray = ["Population", "Male", "Female", "Over 60", "Under 5", "Households", "Households below <br />poverty line"];
        $(currentRegionSelector).animate({ "height": "358px" }, 500);
        if(!$(currentRegionSelector + " .submissionContent").is(":visible")){ 
            $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
        }
        $(currentRegionSelector + " .submissionContent").html("<mark class='demographicsLinks'><strong>Fill out online below or <a href='javascript:demographicsLoader(\"" + currentRegionSelector + "\");' title='Upload CSV document'>Upload .CSV</a></strong>&nbsp;&nbsp;&nbsp;<a href='demographicsTemplate.csv' title='Download the demographics submission template file' target='_blank'>Download .CSV formatted Template</a>&nbsp;&nbsp;&nbsp;&#124;&nbsp;&nbsp;&nbsp;<a href='uploadGuide.pdf' target='_blank' title='Download the guidelines for uploading files'>Guide</a></mark><a href=\"javascript:removeDataSubmitted(\'" + currentRegionSelector + "\');\" title=\"Remove item\" class='remove'>Delete</a><a href=\"javascript:deleteDuringReview('" + currentRegionSelector + "');\" class='delete' title='Delete this report'>Delete</a>")
        for(var i=0; i<7; i++){
            $(".demoInput.generic").clone(true, true).appendTo(currentRegionSelector + " .submissionContent");
            $(currentRegionSelector + " .submissionContent .generic").removeClass("generic").children().each(function(){
                var sectionNumber = currentRegionSelector.replace("#dataSubmissionRegion","");
                if($(this).is("input")){
                    idValue = this.id + i;
                    $(this).attr("id", idValue + "_" + sectionNumber);
                    if(uploadAgain){
                        if($(this).hasClass("demoField")){
                            $(this).val(Math.round(Math.random()*100000));
                        }else{
                            $(this).val("Census 2010");
                        }
                        if(testRequiredFields()){
                            $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
                        }else{
                            $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
                        }
                    }
                }else if($(this).is("label")){
                    var forValue = $(this).attr("for") + i;
                    $(this).attr("for", forValue)
                    if($(this).hasClass("demoLabel")){
                        $(this).html(labelsArray[i]);
                    }else{
                        $(this).css("top","7px");
                    }
	                if(i==6){
	                    $(this).addClass("tallRow");
	                }
                }
            });
        }
        if(!$(currentRegionSelector).hasClass("loaded")){
    	    $(currentRegionSelector).addClass("loaded");
            setTimeout(function(){
        	    var newRegionID = "dataSubmissionRegion" + numberSubmissions;
        	    var newRegionSelector = "#" + newRegionID;
        	    $(".dataSubmissionRegion.generic").clone(true, true).appendTo("#newSubmissionRegions");
        	    $("#newSubmissionRegions .dataSubmissionRegion.generic").removeClass("generic").attr("id", newRegionID).fadeIn(300);
        	    var submissionsDifference = numberSubmissions - numberSubmissionsDeleted;
        	    if(submissionsDifference<10){ submissionsDifference = "0" + submissionsDifference; }
        	    $(newRegionSelector + " h5").text("DATA/REPORT " + submissionsDifference);
        	    $(newRegionSelector).children("div").children("input").each(function(){
        	        $(this).attr("id", this.id + numberSubmissions);
                    $(this).attr("name", $(this).attr("name") + numberSubmissions);
        	    });
        	    $(newRegionSelector).children("div").children("label").each(function(){
        	        $(this).attr("for", $(this).attr("for") + numberSubmissions);
        	    });
        	    $(newRegionSelector + ".cancel").attr("href", "javascript:$('#dataSubmissionRegion" + numberSubmissions + " .uploadView').fadeOut(200); $('#dataSubmissionRegion" + numberSubmissions + "').animate({'height': '47px'},300);")
                numberSubmissions++;
                $('#submitDataContent').animate({scrollTop: $(".dataUploadContainer").height()}, 800);
            },500);
        }
        $(currentRegionSelector).animate({ "height": "358px" }, 300);
        $(currentRegionSelector + " .uploadView").fadeOut(300);
    	setTimeout(function(){
    	    $(currentRegionSelector + " .submissionContent").fadeIn(300);
    	    bindPlaceholderEvents(currentRegionSelector, "demographics");
    	},300);
    	if(numberSubmissions==2){
    	    $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
    	}
    }
    var renumberSubmissionRegions = function(activeRegion){
        if(activeRegion=="restore"){
            var currentNumber = 1;
            $(".dataSubmissionRegion").each(function(){
                if($(this).innerHeight() != 0 && $(this).is(":visible")){
                    if(currentNumber <= 9){ currentNumber = "0" + currentNumber; }
                    $(this).children("h5").text("DATA/REPORT " + currentNumber);
                    if(currentNumber[0]=="0"){ 
                        currentNumber = parseInt(currentNumber[1]) + 1; 
                    } else{
                        currentNumber = parseInt(currentNumber) + 1;
                    }
                }
            })
        }else if($(activeRegion).next().is("#newSubmissionRegions")){
            $(activeRegion).next().children().children("h5").each(function(){
                var currentNumber = parseInt($(this).text().split(" ")[1]) - 1;
                if(currentNumber<9){ currentNumber = "0" + currentNumber; }
                $(this).text("DATA/REPORT " + currentNumber);
            });
            numberSubmissionsDeleted++;
        }else{
            $(activeRegion).nextAll().children("h5").each(function(){
                var currentNumber = parseInt($(this).text().split(" ")[1]) - 1;
                if(currentNumber<9){ currentNumber = "0" + currentNumber; }
                $(this).text("DATA/REPORT " + currentNumber);
            });
            numberSubmissionsDeleted++;
        }
        
    }
    removeDataSubmitted = function(activeRegion){
        $(activeRegion + " .submissionContent").fadeOut(200); 
        $(activeRegion).animate({'height':'0'},300).animate({'margin-top':'0'});
        $(activeRegion + " input:checked").attr("checked", false);
        $(activeRegion + " input:radio").attr("disabled", false);
        $(activeRegion + " .mapOption, " + activeRegion + " .imageOption, " + activeRegion + " .otherOption, " + activeRegion + " .demoOption, " + activeRegion + " .VCAOption").removeAttr("style");
        $(activeRegion).removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission").addClass("removed");
        setTimeout(function(){
            $(activeRegion + " .submissionContent").empty();
            if(testRequiredFields()){
                $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
            }else{
                $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
            }
        },300);
        renumberSubmissionRegions(activeRegion);
    }
    deleteDuringReview = function(activeRegion){
        $(activeRegion).css("min-height","0").animate({"height":"0"},500).animate({"margin-top":"0"},500); 
        setTimeout(function(){ 
            $(activeRegion).removeAttr("style").hide()
        },500);
        renumberSubmissionRegions(activeRegion);
        $(activeRegion).removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission").addClass("removed");
        if(numberSubmissions - numberSubmissionsDeleted - numberSubmissionsHidden == 2){ 
            $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
            setTimeout(function(){ 
                $("#submitDataFooter .backButton").trigger("click"); 
            },500);
        }
        var reviewCount = parseInt($(".dataUploadContainer h4 .reviewCount").text()) - 1;
        if(reviewCount==1){
            $(".dataUploadContainer h4 .reviewCountReports").text("report");
        }else{
            $(".dataUploadContainer h4 .reviewCountReports").text("reports");
        }
        $(".dataUploadContainer h4 .reviewCount").text(reviewCount);
        
    }
});

// function to open/close sub-geography popup
var showSubGeo = function(popup,fadeSpeed){
    if(typeof activeWindow !== 'undefined'){
        clearTimeout(activeWindow.data('timeout'));
        activeWindow.fadeOut(fadeSpeed);
    }
    popup.fadeIn(fadeSpeed);
    activeWindow = popup;
    subGeoShowing = true;
};

var hideSubGeo = function(popup, fadeSpeed){
    popup.fadeOut(fadeSpeed);
    subGeoShowing = false;
};
var toggleIconLayer = function(){
    if($("#l2_breadcrumb").is(":visible")){
        switch(markersOn){
            case false:
                $("#mapSection").css("background", 'url("img/assets/mapIconOnPng8.png") no-repeat center top transparent');
                $("#volunteerSection").css("background", 'url("img/assets/volunteerIconOnPng8.png") no-repeat center top transparent');
                $(".iconSection").css("color", "#565656");
                markersOn=true;
                break;
            case true:
                $("#mapSection").css("background", 'url("img/assets/mapIconOffPng8.png") no-repeat center top transparent');
                $("#volunteerSection").css("background", 'url("img/assets/volunteerIconOffPng8.png") no-repeat center top transparent');
                $(".iconSection").css("color", "#ccc")
                markersOn=false;
                break;
        }
    }
};
var globalView = function(){
    $("#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb, #show-hide, #divider, #analysisLink, #indicator, #risingTab").hide();
    $(".hidden").hide("slow");
    $(".geoType").html("");
    $(".geoName").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a country");
    $(".activeWindow").fadeOut(300);
    $(".activeWindow").removeClass("activeWindow");
    $(".countryWindow").addClass("activeWindow");
    $(".activeWindow").fadeIn(300);
    $(".year").html("");
    refreshDropdowns("kitten");
};
var showReports = function(section){
    $(".rowForApproval").hide();
    $(".rowForApproval").prev().find(".closeReviewButton").hide();
    $(".rowForApproval").prev().find(".reviewButton").show();
    $(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");
    $(".headerRow.activeSection").removeClass("activeSection");
    $("." + section + "Header").addClass("activeSection");
    $(".headerRow.activeSection .arrow").html("&darr;");
    $(".activeContent").hide();
    $(".activeContent").removeClass("activeContent");
    $(".activeSection").next().addClass("activeContent");
    $(".activeSection").parent().next().addClass("activeContent");
    $(".activeContent").css("display", "block");
    $(".approvalScreen").hide();
    $("#lightbox, #reportsSection").fadeIn(300);
    resizeReports();
}
var toggleReports = function(filter){
    switch(filter){
        case "myReports":
            $(".allReports").removeClass("active").html("<a href=\"javascript:toggleReports('allReports')\" title='All Reports'>ALL REPORTS</a>");
            $(".myReports").addClass("active").html("MY REPORTS");
            break;
        case "allReports":
            $(".myReports").removeClass("active").html("<a href=\"javascript:toggleReports('myReports')\" title='My Reports'>MY REPORTS</a>")
            $(".allReports").addClass("active").html("ALL REPORTS");
            break;
    }
};
var showAnalysis = function(){
    $("#analysis").fadeIn(300);
    // $("#analysisToggle").css("left", 145 + $("#drawerTop .geoType").parent().innerWidth() + "px");
    // $("#backToMap").css("left", 347 + $("#drawerTop .geoType").parent().innerWidth() + "px");
    $("#reportsTopBar, #dataTopBar").fadeOut(300);
    $(".hidden").hide('slow');
    $("#show-hide").html("<span class='arrow'>&uarr;</span> SHOW MORE");
    if(drawerOpen){
        drawerOpen=false;
        setTimeout(function(){ $("#drawer").fadeOut(500); $("#analysisDrawerTop").fadeIn(500); }, 400)
    }else{ 
        $("#drawer").fadeOut(300);
        $("#analysisDrawerTop").fadeIn(300);
    }
    $(".eventMarkers").empty();
    for(var i=0; i< Math.ceil(Math.random()*20); i++){
        var left = Math.ceil(Math.random()*695);
        $(".eventMarkers").append("<div class='eventTriangle' style='left:" + left + "px;'></div>");
    }
};
var hideAnalysis = function(){
    $("#analysis, #analysisDrawerTop").fadeOut(300);
    $("#risingTab, #drawer, #reportsTopBar, #dataTopBar").fadeIn(300); 
}
var toggleAnalysis = function(){
    switch($("#analysisToggle select").val()){
        case "indicators":
            $("#analysisControl1, #analysisControl2, #analysisControl3, .lineGraphContainer, .eventMarkers, #analysisTimelineContainer, .regionIndicators").fadeOut(300);
            $("#analysisIndicatorsChart").css("height", $("#analysis").innerHeight()-141 + "px").fadeIn(300);
            setTimeout(function(){
                $(".regionIndicators h3, .regionIndicators .indicatorRating").hide();
                $(".regionIndicators input, .regionIndicators .popup h3").show();
                $("#analysis .regionIndicators").css("top", "210px");
                $(".regionIndicators").fadeIn(300);
            },500);
            $(".analysisDescription h2").html("Click to dive in to regions or rollover to see more.");
            $(".geoType span").html("in");
            $("#analysisDrawerTop .year").html($(".analysisUpperYearHidden").html());
            $(".analysisKey").css("width", "240px");
            $(".noDataBlock").fadeIn(300);
            break;
        case "overall":
            $("#analysisControl1, #analysisControl2, #analysisControl3, .lineGraphContainer, .eventMarkers, #analysisTimelineContainer").fadeIn(300);
            $(".regionIndicators, #analysisIndicatorsChart").fadeOut(300);
            setTimeout(function(){
                $(".regionIndicators h3, .regionIndicators .indicatorRating").show();
                $(".regionIndicators input").hide();
                $("#analysis .regionIndicators").css("top", "41%");
                $(".regionIndicators").fadeIn(300);
            },500);
            $(".geoType span").html("from");
            $("#analysisDrawerTop .year").html($(".analysisLowerYearHidden").html() + "&ndash;" + $(".analysisUpperYearHidden").html());
            $(".analysisDescription h2").html("Select <strong>up to 3 locations</strong> to compare overall resilience");
            $(".analysisKey").css("width", "190px");
            $(".noDataBlock").hide();
            break;
    }
}
var showSubmitData = function(toggle){
    $("#submitDataContent .dataUploadContainer h3, .delete, .reviewTitling, #submitDataContent .thankyou, .loadingErrorView").hide();
    $("#submitDataFooter div, #submitDataFooter mark").hide();
    $("#submitDataFilters #submissionToggle, #submitDataFilters h3").show();
    $("#dataAndReportsSubmissionViews .dataUploadContainer").show();
    $(".fileType, .labelFile, .remove, .imgDesc, .fakePlaceholder, .labelHangRight, .checkHangRight").show();
    $("#submitIndicators, #submitReports").removeClass("active");
    $("#submitDataFilters").css("background-color", "#c6c6c6");
    $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
    $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
    $("#dataSubmissionRegion1 input").attr("checked", false);
    $(".dataSubmissionRegion input:radio").each(function(){
            $(this).parent().removeAttr("style");
            $(this).removeAttr("disabled");
    });
    $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
    $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
    $("#submitDataContent .dataUploadContainer h4").html("Select data type");
    numberSubmissions = 2;
    numberSubmissionsDeleted = 0;
    switch(toggle){
        case "indicators":
            $("#submitIndicators").addClass("active");
            $("#indicatorsSubmissionViews").show();
            $("#dataAndReportsSubmissionViews").hide();
            $("#indicatorsSubmissionViews").children("div").hide();
            $("#submitDataFooter div, #submitDataFooter mark").removeAttr("style");
            $("#submitDataFooter .reviewSubmissionButton").removeClass('disabled');
            $("#submitDataContent .indicatorsStart").show();
            break;
        case "reports":
            $("#submitReports").addClass("active");
            $("#dataAndReportsSubmissionViews").show();
            $("#indicatorsSubmissionViews").hide();
            break;
    }
    $("#lightbox, #submitDataSection").fadeIn(300);
}
var indicatorsCheckCommune = function(){
    switch($("#l3_data").val()){
        case "na":
            $("#submitOnlineButton").addClass("disabled");
            $("#submitDataContent .indicatorsStart p").filter(":first").show(200);
            break;
        default:
            $("#submitOnlineButton").removeClass("disabled");
            $("#submitDataContent .indicatorsStart p").filter(":first").hide(200);
    }
}